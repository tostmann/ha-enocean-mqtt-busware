<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnOcean MQTT Slim</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .card-clickable {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .info-badge {
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-radio-tower"></i> EnOcean MQTT Slim
            </span>
            <span class="badge bg-success" id="status-badge">Loading...</span>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Alert Banner -->
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-success" role="alert">
                    <h4 class="alert-heading"><i class="bi bi-check-circle"></i> System Running</h4>
                    <p>EnOcean MQTT Slim is active and monitoring for telegrams.</p>
                    <hr>
                    <p class="mb-0">
                        <strong>Version:</strong> 1.0.2 | 
                        <strong>MQTT:</strong> <span id="mqtt-status">Checking...</span> |
                        <strong>Gateway:</strong> <span id="gateway-status">Checking...</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mt-4">
            <!-- Gateway Card -->
            <div class="col-md-4">
                <div class="card card-clickable" onclick="showGatewayInfo()">
                    <div class="card-body text-center">
                        <i class="bi bi-hdd-network display-4 text-primary"></i>
                        <h5 class="card-title mt-3">Gateway</h5>
                        <p class="card-text">
                            <span class="badge bg-success" id="gateway-badge">Connected</span><br>
                            <small class="text-muted">Click for details</small>
                        </p>
                    </div>
                </div>
            </div>

            <!-- EEP Profiles Card -->
            <div class="col-md-4">
                <div class="card card-clickable" onclick="showEEPProfiles()">
                    <div class="card-body text-center">
                        <i class="bi bi-file-earmark-code display-4 text-info"></i>
                        <h5 class="card-title mt-3">EEP Profiles</h5>
                        <p class="card-text">
                            <strong id="eep-count">1</strong> profile loaded<br>
                            <small class="text-muted">Click to view</small>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Devices Card -->
            <div class="col-md-4">
                <div class="card card-clickable" onclick="showDevices()">
                    <div class="card-body text-center">
                        <i class="bi bi-router display-4 text-warning"></i>
                        <h5 class="card-title mt-3">Devices</h5>
                        <p class="card-text">
                            <strong id="device-count">0</strong> configured<br>
                            <small class="text-muted">Click to manage</small>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-activity"></i> System Status</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshStatus()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush" id="status-list">
                            <li class="list-group-item">
                                <i class="bi bi-hourglass-split text-warning"></i> Loading status...
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Panel (Hidden by default) -->
        <div class="row mt-4" id="info-panel" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span id="info-title"><i class="bi bi-info-circle"></i> Information</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="hideInfoPanel()">
                            <i class="bi bi-x"></i> Close
                        </button>
                    </div>
                    <div class="card-body" id="info-content">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="row mt-4 mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-link-45deg"></i> Quick Links
                    </div>
                    <div class="card-body">
                        <a href="https://github.com/ESDN83/ha-enocean-mqtt-slim" class="btn btn-outline-primary me-2" target="_blank">
                            <i class="bi bi-github"></i> GitHub
                        </a>
                        <a href="https://github.com/ESDN83/ha-enocean-mqtt-slim/issues" class="btn btn-outline-secondary me-2" target="_blank">
                            <i class="bi bi-bug"></i> Report Issue
                        </a>
                        <a href="https://github.com/ESDN83/ha-enocean-mqtt-slim/blob/main/addon/DOCS.md" class="btn btn-outline-info" target="_blank">
                            <i class="bi bi-book"></i> Documentation
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fetch status on load
        window.addEventListener('load', function() {
            refreshStatus();
        });

        async function refreshStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                // Update badges
                document.getElementById('status-badge').textContent = data.status === 'running' ? 'Running' : 'Stopped';
                document.getElementById('eep-count').textContent = data.eep_profiles || 1;
                document.getElementById('device-count').textContent = data.devices || 0;
                document.getElementById('mqtt-status').textContent = data.mqtt_connected ? 'Connected' : 'Disconnected';
                document.getElementById('gateway-status').textContent = data.gateway_connected ? 'Connected' : 'Disconnected';
                
                // Update status list
                const statusList = document.getElementById('status-list');
                statusList.innerHTML = `
                    <li class="list-group-item">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        ESP3 Protocol Handler - Active
                    </li>
                    <li class="list-group-item">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        Serial Communication - ${data.gateway_connected ? 'Connected' : 'Disconnected'}
                    </li>
                    <li class="list-group-item">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        EEP Profile System - ${data.eep_profiles} profile(s) loaded
                    </li>
                    <li class="list-group-item">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        Telegram Listener - Running
                    </li>
                    <li class="list-group-item">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        MQTT Integration - ${data.mqtt_connected ? 'Connected' : 'Disconnected'}
                    </li>
                    <li class="list-group-item">
                        <i class="bi bi-check-circle-fill text-success"></i> 
                        Device Management - ${data.devices} device(s) configured
                    </li>
                `;
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        function showGatewayInfo() {
            const infoPanel = document.getElementById('info-panel');
            const infoTitle = document.getElementById('info-title');
            const infoContent = document.getElementById('info-content');
            
            infoTitle.innerHTML = '<i class="bi bi-hdd-network"></i> Gateway Information';
            infoContent.innerHTML = `
                <h5>EnOcean USB Gateway</h5>
                <table class="table table-sm">
                    <tr><th>Status:</th><td><span class="badge bg-success">Connected</span></td></tr>
                    <tr><th>Base ID:</th><td><code id="gateway-base-id">Loading...</code></td></tr>
                    <tr><th>Version:</th><td><span id="gateway-version">Loading...</span></td></tr>
                    <tr><th>Chip ID:</th><td><code id="gateway-chip-id">Loading...</code></td></tr>
                    <tr><th>Description:</th><td><span id="gateway-desc">Loading...</span></td></tr>
                </table>
                <p class="text-muted"><small>Check addon logs for detailed gateway information</small></p>
            `;
            
            infoPanel.style.display = 'block';
            infoPanel.scrollIntoView({ behavior: 'smooth' });
            
            // Fetch gateway info from logs or API
            fetch('/api/gateway-info').then(r => r.json()).then(data => {
                if (data.base_id) document.getElementById('gateway-base-id').textContent = data.base_id;
                if (data.version) document.getElementById('gateway-version').textContent = data.version;
                if (data.chip_id) document.getElementById('gateway-chip-id').textContent = data.chip_id;
                if (data.description) document.getElementById('gateway-desc').textContent = data.description;
            }).catch(() => {
                document.getElementById('gateway-base-id').textContent = 'See addon logs';
                document.getElementById('gateway-version').textContent = 'See addon logs';
                document.getElementById('gateway-chip-id').textContent = 'See addon logs';
                document.getElementById('gateway-desc').textContent = 'See addon logs';
            });
        }

        function showEEPProfiles() {
            const infoPanel = document.getElementById('info-panel');
            const infoTitle = document.getElementById('info-title');
            const infoContent = document.getElementById('info-content');
            
            infoTitle.innerHTML = '<i class="bi bi-file-earmark-code"></i> EEP Profiles';
            infoContent.innerHTML = `
                <h5>Loaded EEP Profiles</h5>
                <ul class="list-group">
                    <li class="list-group-item">
                        <strong>MV-01-01</strong> - Kessel Staufix Control
                        <br><small class="text-muted">Backwater alarm system</small>
                    </li>
                </ul>
                <p class="mt-3 text-muted"><small>More EEP profiles coming in future versions</small></p>
            `;
            
            infoPanel.style.display = 'block';
            infoPanel.scrollIntoView({ behavior: 'smooth' });
        }

        function showDevices() {
            const infoPanel = document.getElementById('info-panel');
            const infoTitle = document.getElementById('info-title');
            const infoContent = document.getElementById('info-content');
            
            infoTitle.innerHTML = '<i class="bi bi-router"></i> Device Management';
            infoContent.innerHTML = `
                <h5>Configured Devices</h5>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 
                    <strong>Manual Configuration Required</strong><br>
                    Create <code>/data/devices.json</code> to add devices.<br>
                    Web-based device management coming in next version!
                </div>
                <h6>Example Configuration:</h6>
                <pre class="bg-light p-3"><code>{
  "05834fa4": {
    "id": "05834fa4",
    "name": "Staufix Control",
    "eep": "MV-01-01",
    "manufacturer": "Kessel",
    "enabled": true
  }
}</code></pre>
                <p class="text-muted"><small>After creating the file, restart the addon to load devices.</small></p>
            `;
            
            infoPanel.style.display = 'block';
            infoPanel.scrollIntoView({ behavior: 'smooth' });
        }

        function hideInfoPanel() {
            document.getElementById('info-panel').style.display = 'none';
        }

        // Auto-refresh every 30 seconds
        setInterval(refreshStatus, 30000);
    </script>
</body>
</html>
